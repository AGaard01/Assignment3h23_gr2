---
title: "Assignment 3; Pendling"
format: html
editor: visual
language: nb.yaml
---

```{r}
#| label: setup
#| output: false
#| message: false
#| echo: false
library(tidyverse)
library(tidyselect)
library(lubridate)
library(PxWebApiData)
library(flextable)
```

# Innledning

## Kommuner på Haugalandet 2022

# Hente data fra SSB

```{r}
#Get more info about table
ApiData(
"http://data.ssb.no/api/v0/en/table/03321",
returnApiQuery = TRUE
) 
```

```{r}
#| cache: true
# Datasett med arbeidstakere som bor på Haugalandet
pend_00_22_ssb_boHland <- PxWebApiData::ApiData12(
  urlToData = as.character(03321),
  ArbstedKomm = list("*"),
  Bokommuen = c("1106", "1135", "1145", "1146", "1149", "1154", "1159", "1160", "4611", "4612", "1211", "1216"),
  Tid = as.character(2000:2022)
)
```

```{r}
#| cache: true
# Datasett antall arbeidstakere som arbeider på Haugalandet
pend_00_22_ssb_arbHland <- PxWebApiData::ApiData12(
  urlToData = as.character(03321),
  ArbstedKomm = c("1106", "1135", "1145", "1146", "1149", "1154", "1159", "1160", "4611", "4612", "1211", "1216"),
  Bokommuen = list("*"),
  Tid = as.character(2000:2022)
)
```

```{r}
pend_00_22_arbHland <- pend_00_22_ssb_arbHland |> 
  select(
    aar = Tid,
    arb_kom = arbeidsstedskommune,
    bo_kom = bostedskommune,
    pendlere = value
  )
```

```{r}
pend_00_22_boHland <- pend_00_22_ssb_boHland |> 
  select(
    aar = Tid,
    arb_kom = arbeidsstedskommune,
    bo_kom = bostedskommune,
    pendlere = value
  )
```

```{r}
print(pend_00_22_boHland, n = 5)
```

```{r}
print(pend_00_22_arbHland, n = 5)
```

```{r}
pend_00_22_arbHland$arb_kom <- fct(pend_00_22_arbHland$arb_kom)
pend_00_22_boHland$bo_kom <- fct(pend_00_22_boHland$bo_kom)

pend_00_22_arbHland$arb_kom <- fct_collapse(pend_00_22_arbHland$arb_kom, 
                                      Haugesund = "Haugesund",
                                      Sauda = "Sauda",
                                      Bokn = "Bokn",
                                      Tysvær = "Tysvær",
                                      Karmøy = "Karmøy",
                                      Sveio = c("Sveio", "Sveio (-2019)"),
                                      Etne = c("Etne", "Etne (-2019)"),
                                      Vindafjord = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
                                      other_level = "Andre")
```

```{r}
pend_00_22_arbHland$bo_kom <- fct_collapse(pend_00_22_arbHland$bo_kom, 
                                      Haugesund = "Haugesund",
                                      Sauda = "Sauda",
                                      Bokn = "Bokn",
                                      Tysvær = "Tysvær",
                                      Karmøy = "Karmøy",
                                      Sveio = c("Sveio", "Sveio (-2019)"),
                                      Etne = c("Etne", "Etne (-2019)"),
                                      Vindafjord = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
                                      other_level = "Andre")
```

```{r}
pend_00_22_boHland$bo_kom <- fct_collapse(pend_00_22_boHland$bo_kom, 
                                     Haugesund = "Haugesund",
                                     Sauda = "Sauda",
                                     Bokn = "Bokn",
                                     Tysvær = "Tysvær",
                                     Karmøy = "Karmøy",
                                     Sveio = c("Sveio", "Sveio (-2019)"),
                                      Etne = c("Etne", "Etne (-2019)"),
                                     Vindafjord = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
                                     other_level = "Andre")
```

```{r}
pend_00_22_boHland$arb_kom <- fct_collapse(pend_00_22_boHland$arb_kom, 
                                      Haugesund = "Haugesund",
                                      Sauda = "Sauda",
                                      Bokn = "Bokn",
                                      Tysvær = "Tysvær",
                                      Karmøy = "Karmøy",
                                      Sveio = c("Sveio", "Sveio (-2019)"),
                                      Etne = c("Etne", "Etne (-2019)"),
                                      Vindafjord = c("Vindafjord", "Vindafjord (1965-2005)", "Ølen (2002-2005)"),
                                      other_level = "Andre")
```

```{r}
# eval: false
   pend_00_22_arbHland <- pend_00_22_arbHland |>
     group_by(aar, bo_kom, arb_kom) |>
     summarise(pendlere = sum(pendlere), .groups = "drop")
```

```{r}
dim(pend_00_22_arbHland)
```

```{r}
pend_00_22_arbHland |>
     head(n = 5)
```

```{r}
# eval: false
   pend_00_22_boHland <- pend_00_22_boHland |>
     group_by(aar, arb_kom, bo_kom) |>
     summarise(pendlere = sum(pendlere), .groups = "drop")
```

```{r}
dim(pend_00_22_boHland)
```

```{r}
pend_00_22_boHland |>
     head(n = 5)
```

```{r}
pmat_long <- pend_00_22_arbHland |> 
  full_join(
    pend_00_22_boHland,
    by = c("aar", "arb_kom", "bo_kom", "pendlere")
  ) |> 
  ungroup()
```

```{r}
dim(pmat_long)
```

```{r}
pmat_long |> head(n = 5)
```

```{r}
# Anta at 'pmat_long' er ditt primære datasett og inneholder kolonnene 'aar', 'bo_kom', 'arb_kom', og 'pendlere'.

# Beregn 'bo_percent' og 'arb_percent' direkte i 'pmat_long'
pmat_long <- pmat_long %>%
  group_by(bo_kom, aar) %>%
  mutate(total_bo_kom = sum(pendlere), 
         bo_percent = round((pendlere / total_bo_kom) * 100, 1)) %>%
  ungroup() %>%
  group_by(arb_kom, aar) %>%
  mutate(total_arb_kom = sum(pendlere), 
         arb_percent = round((pendlere / total_arb_kom) * 100, 1)) %>%
  ungroup() %>%
  select(-total_bo_kom, -total_arb_kom)

# Skriv ut 'pmat_long' for å bekrefte endringene
print(head(pmat_long))
```

```{r}
dim(pmat_long)
```

```{r}
pmat_long |> head(n = 5)
```

## Rekkefølge kommunene

## Et lite eksempel

## Rekkefølge på rekker og kolonner i pendlematrisene

## Pendlematriser

# Spørsmål

## Spørsmål vedrørende pendle/andels-matrisene for 2000

## Spørsmål vedrørende pendle/andels-matrisene for 2012

## Spørsmål vedrørende pendle/andels-matrisene for 2022

# Plots

## Oppgave
